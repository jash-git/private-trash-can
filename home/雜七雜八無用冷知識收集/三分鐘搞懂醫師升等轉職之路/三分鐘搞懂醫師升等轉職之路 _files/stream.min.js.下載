(function($){var _moreArticleDiv=$("#stream-topic-more");(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date;a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-65168598-33","auto","streamtopic");bindSelectvent();traceTopicTagClick();function getText(){if(!window.getSelection){return""}return window.getSelection().toString().replace(/(\r\n|\n|\r)/gm,"")}function getPosition(){var rect=window.getSelection().getRangeAt(0).getBoundingClientRect();return{top:window.scrollY+rect.top-rect.height,left:(rect.left+rect.right)/2}}function reset(){_moreArticleDiv.hide()}function recordEvent(action,label){ga("streamtopic.send","event","streamtopic",action,label)}function traceTopicTagClick(){var desktopData=$(".article-head").children(".title").data(),mobileData=$(".article-header").children(".header-title").data(),articleCat=(desktopData||mobileData).siteCategory,_tagContainer=$(".tag-container");if(!_tagContainer.length){_tagContainer=$(".article-keyword")}_tagContainer.on("click",".topic",function(evt){var link=$(evt.target),index=link.index(),version=_tagContainer.data().version,action="文章標籤"+version+"-導流"+index,label="文章內頁-文章標籤"+version+"-"+articleCat;recordEvent(action,label)})}function bindSelectvent(){if(!_moreArticleDiv||!_moreArticleDiv.length){return}$.ajax({url:"https://streamtopic.pixnet.net/api/topics?token="+pix.jwtToken,type:"GET",cache:true}).then(function(data){var _moreArticleLink=_moreArticleDiv.children("a"),topicMapping={},i,topic;for(i=0;i<data.length;i++){topic=data[i];topicMapping[topic.name]=topic}document.addEventListener("selectionchange",function(){var text=getText(),topic=topicMapping[text];if(!text||text.length>10||!topic){reset();return}var pos=getPosition();_moreArticleLink.html(text).attr("href",topic.link);_moreArticleDiv.css(pos).show()});_moreArticleLink.on("click",function(){recordEvent("文章內容反灰","文章內頁-內容反灰")})})}})(jQuery);
